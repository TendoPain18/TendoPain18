name: Sync Contact Section to All Repos

on:
  push:
    branches: [main]
    paths:
      - 'README.md'
  workflow_dispatch:

jobs:
  sync-contact:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v3
        with:
          path: profile
      
      - name: Extract contact section
        run: |
          cd profile
          if grep -q "<!-- CONTACT -->" README.md && grep -q "<!-- END CONTACT -->" README.md; then
            sed -n '/<!-- CONTACT -->/,/<!-- END CONTACT -->/p' README.md > contact.md
            echo "Contact section extracted successfully"
            cat contact.md
          else
            echo "ERROR: Contact markers not found in profile README"
            exit 1
          fi
      
      - name: Get all repositories
        id: get-repos
        run: |
          curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/users/TendoPain18/repos?per_page=100&type=owner" | \
            jq -r '.[].name' | grep -v "^TendoPain18$" > repos.txt
          
          echo "Found repositories:"
          cat repos.txt
      
      - name: Update all repos with contact tags
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          updated_repos=0
          skipped_repos=0
          error_repos=0
          
          while IFS= read -r repo; do
            echo ""
            echo "======================================="
            echo "Checking repository: $repo"
            echo "======================================="
            
            if git clone "https://${{ secrets.PAT_TOKEN }}@github.com/TendoPain18/${repo}.git" "repo_${repo}" 2>/dev/null; then
              cd "repo_${repo}"
              
              if [ ! -f "README.md" ]; then
                echo "No README.md found, skipping"
                cd ..
                rm -rf "repo_${repo}"
                skipped_repos=$((skipped_repos + 1))
                continue
              fi
              
              if grep -q "<!-- CONTACT -->" README.md && grep -q "<!-- END CONTACT -->" README.md; then
                echo "Contact tags found! Updating..."
                
                sed -i '/<!-- CONTACT -->/,/<!-- END CONTACT -->/d' README.md
                
                echo "" >> README.md
                cat ../profile/contact.md >> README.md
                
                git config user.name "Contact Sync Bot"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                
                if git diff --quiet README.md; then
                  echo "No changes needed, already up to date"
                  skipped_repos=$((skipped_repos + 1))
                else
                  git add README.md
                  git commit -m "chore: Auto-sync contact section from profile"
                  
                  if git push; then
                    echo "Successfully updated!"
                    updated_repos=$((updated_repos + 1))
                  else
                    echo "Failed to push changes"
                    error_repos=$((error_repos + 1))
                  fi
                fi
              else
                echo "No contact tags found, skipping"
                skipped_repos=$((skipped_repos + 1))
              fi
              
              cd ..
              rm -rf "repo_${repo}"
            else
              echo "Failed to clone repository"
              error_repos=$((error_repos + 1))
            fi
          done < repos.txt
          
          echo ""
          echo "======================================="
          echo "         SYNC SUMMARY"
          echo "======================================="
          echo "Updated: $updated_repos repositories"
          echo "Skipped: $skipped_repos repositories"
          echo "Errors: $error_repos repositories"
          echo "======================================="
      
      - name: Create job summary
        run: |
          echo "## ðŸ”„ Contact Section Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The contact section has been synchronized across all repositories with contact tags." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Repositories Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed information about each repository." >> $GITHUB_STEP_SUMMARY
